global [ packetsize ]

to ul-power
	init-onboardleds
	redon
	wait 10
	redoff
end

to ul-init
	yellowon
	init-sd
	setpacketsize 16
	wait 10
	yellowoff
end

to ul-go
	greenon
	wait 10 
	greenoff
	loop 
	[
		blueon
		wait 10
		collect-data
		blueoff
		wait 100	
	]
end

to read-IR-sensor
	output readADC 0
end

to read-Optical-sensor
	output readADC 1
end

to test-sd
	
    setSD_Block_High 0 
    setSD_Block_Low 0
    init-sd
    erase-sd 0 0 0 1 
    
    setm 0
    repeat 64 [
       setn 0
       repeat 8 [
          writeb ($1500 + n) m   
          setn n + 1          
       ]
       SD-Log-Chunk $1500 8
       setm m + 1                
    ]

    sd-clear-buffer     
    logread-sd          

    read-sd 0 0          
    logread-sd         
    uninit-sd

end

to collect-data
	blueon
	init-packet 10
	packet-word read-IR-sensor
	packet-word read-Optical-sensor
	add-checksum
	wait 10
	blueoff
end

to write-packet-sd
	setn 0
	repeat packetsize [
		print readb  ($1fc0 + n)
		setn n + 1	
	]
	SD-Log-Chunk $1fc0 packetsize
end
