global [ packetsize, sdindex ]

to ul-power
	init-onboardleds
	redon
	wait 10
	redoff
	ul-init
end

to ul-init
	yellowon
	sd-clear-buffer
	setpacketsize 16
	setSD_Block_High 0
        setSD_Block_Low 0
	init-sd
	wait 10
	yellowoff
end

to ul-go
	greenon
	wait 10 
	greenoff
	loop 
	[
		blueon
		wait 10
		collect-data
		blueoff
		print SD_Block_High
		print SD_Block_Low
		wait 100	

	]
end

to read-IR-sensor
	output readADC 0
end

to read-Optical-sensor
	output readADC 1
end

to test-sd
    setSD_Block_High 0   ; Setting start block
    setSD_Block_Low 0

    init-sd              ; Initiate SD

    erase-sd 0 0 0 1     ; erase-first block

    setm 0

    repeat 64 [
       setn 0
       repeat 8 [
          writeb ($1500 + n) n   ; write 8 bytes to sub buffer
          setn n + 1             ; Bump Count
       ]
       SD-Log-Chunk $1500 8      ; Log the sub buffer to sd buffer
       setm m + 1                ; Bump Count
    ]

    sd-clear-buffer     ; Clear SD Buffer
    logread-sd          ; display buffer: should respond all 0's

    read-sd 0 0          ; read block 0
    logread-sd           ; display block: should respond all 0's

    uninit-sd           ; Put SD on standby
	
	
end

to collect-data
	blueon
	init-packet 10
	packet-word read-IR-sensor
	packet-word read-Optical-sensor
	add-checksum
	write-packet-sd
	wait 10
	blueoff
end

to write-packet-sd

	init-sd	
	
	setn 0
	repeat packetsize [
		writeb ($1500 + n ) (readb ($1fc0 + n))
		setn n + 1
	]

	SD-Log-Chunk $1500 512

	sd-clear-buffer     ; Clear SD Buffer
	logread-sd          ; display buffer: should respond all 0's
	read-sd 0 0          ; read block 0
	logread-sd           ; display block: should respond all 0's
	uninit-sd           ; Put SD on standby
	
end
