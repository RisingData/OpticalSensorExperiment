global [ packetsize, sdindex ]

to ul-power
	init-onboardleds
	redon
	wait 10
	redoff
	ul-init
end

to ul-init
	yellowon
	setpacketsize 16
	setSD_Block_High 0
        setSD_Block_Low 0
	init-sd
	wait 10
	yellowoff
end

to ul-go
	greenon
	wait 10 
	greenoff
	loop 
	[
		blueon
		wait 10
		collect-data
		blueoff
		wait 100	
	]
end

to read-IR-sensor
	output readADC 0
end

to read-Optical-sensor
	output readADC 1
end

to test-sd
	
	test-sd-init    
	test-sd-write

	sd-clear-buffer
	logread-sd          

	read-sd 0 0          
	logread-sd         
	
end

to test-sd-init
	erase-sd 0 0 0 1
end

to test-sd-write
	repeat 64 [
        setn 0
        repeat packetsize [
           writeb ($1500 + n) ( readb ( $1fc0 + n ) )
           setn n + 1
        ]
        SD-Log-Chunk $1500 packetsize
        setm m + 1
    ]

end

to collect-data
	blueon
	init-packet 10
	packet-word read-IR-sensor
	packet-word read-Optical-sensor
	add-checksum
	wait 10
	blueoff
end

to write-packet-sd
	setn 0
	repeat packetsize [
		writeb ($1500 + n ) ( readb  ($1fc0 + n ))
		setn n + 1	
	]
	SD-Log-Chunk $1500 packetsize
end
